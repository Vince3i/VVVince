<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PoseMate - æ‹ç…§æ­å­ç½‘é¡µç‰ˆ</title>
    <style>
        /* 1. åŸºç¡€æ ·å¼ï¼šå…¨å±é»‘åº• */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden; /* ç¦æ­¢æ»šåŠ¨ */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        /* 2. è§†é¢‘å±‚ï¼šé“ºæ»¡å±å¹• */
        #camera-feed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* ä¿æŒæ¯”ä¾‹å¡«æ»¡ */
            z-index: 1;
        }

        /* 3. å¼•å¯¼å±‚ (Overlay)ï¼šåŠé€æ˜è¾…åŠ©çº¿ */
        #guide-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none; /* è®©ç‚¹å‡»äº‹ä»¶ç©¿é€åˆ°ä¸‹å±‚ */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* æç¤ºæ–‡å­— */
        #tip-box {
            position: absolute;
            top: 10%;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            text-align: center;
            max-width: 80%;
            z-index: 3;
            pointer-events: none;
        }

        /* 4. æ§åˆ¶å±‚ï¼šæŒ‰é’®åŒºåŸŸ */
        #controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 180px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            z-index: 4;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 30px;
        }

        /* åœºæ™¯é€‰æ‹©æŒ‰é’®å®¹å™¨ */
        .scenario-scroll {
            display: flex;
            overflow-x: auto;
            width: 100%;
            padding: 10px 0;
            margin-bottom: 20px;
            -webkit-overflow-scrolling: touch; /* iOSé¡ºæ»‘æ»šåŠ¨ */
        }

        .scenario-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            padding: 8px 16px;
            margin: 0 8px;
            white-space: nowrap;
            font-size: 14px;
            cursor: pointer;
        }

        .scenario-btn.active {
            background: #ffc107; /* æ¿€æ´»è‰² */
            color: black;
            border-color: #ffc107;
            font-weight: bold;
        }

        /* å¿«é—¨æŒ‰é’® */
        #shutter-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: white;
            border: 4px solid rgba(255, 255, 255, 0.4);
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        #shutter-btn:active {
            transform: scale(0.95);
            background-color: #ddd;
        }

        /* --- å…·ä½“çš„æ„å›¾è¾…åŠ©çº¿æ ·å¼ --- */

        /* å’–å•¡é¦†æ ·å¼ */
        .guide-cafe .frame {
            width: 60%;
            height: 40%;
            border: 2px dashed rgba(255, 193, 7, 0.7);
            border-radius: 10px;
            position: relative;
        }
        .guide-cafe .frame::after {
            content: "äººç‰©ä¸ŠåŠèº«";
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255, 193, 7, 0.7);
        }

        /* è¡—æ‹ä¸‰åˆ†çº¿æ ·å¼ */
        .guide-street {
            width: 100%;
            height: 100%;
        }
        .guide-street .grid-line-h {
            position: absolute;
            width: 100%; height: 1px;
            background: rgba(255, 255, 255, 0.3);
        }
        .guide-street .grid-line-v {
            position: absolute;
            height: 100%; width: 1px;
            background: rgba(255, 255, 255, 0.3);
        }
        /* ç„¦ç‚¹æç¤ºç‚¹ */
        .guide-street .focus-point {
            position: absolute;
            top: 33%; right: 33%;
            width: 40px; height: 40px;
            border: 2px solid red;
            border-radius: 50%;
            transform: translate(50%, -50%);
        }

        /* å…¬å›­å…¨èº«æ ·å¼ */
        .guide-park .silhouette {
            width: 40%;
            height: 70%;
            border: 3px solid rgba(76, 175, 80, 0.6);
            border-radius: 50px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 20px;
            color: rgba(76, 175, 80, 0.6);
        }

        /* éšè—çš„ Canvas ç”¨äºæˆªå›¾ */
        canvas { display: none; }
    </style>
</head>
<body>

    <video id="camera-feed" autoplay playsinline muted></video>

    <div id="tip-box">è¯·å…è®¸æ‘„åƒå¤´æƒé™ä»¥å¼€å§‹ä½¿ç”¨</div>

    <div id="guide-overlay">
        </div>

    <div id="controls">
        <div class="scenario-scroll">
            <button class="scenario-btn active" onclick="setScenario('none')">æ— å¼•å¯¼</button>
            <button class="scenario-btn" onclick="setScenario('cafe')">â˜•ï¸ å’–å•¡é¦†</button>
            <button class="scenario-btn" onclick="setScenario('street')">ğŸš¶ è¡—æ‹</button>
            <button class="scenario-btn" onclick="setScenario('park')">ğŸŒ³ å…¬å›­</button>
        </div>
        <div id="shutter-btn" onclick="takePhoto()"></div>
    </div>

    <canvas id="photo-canvas"></canvas>

    <script>
        const video = document.getElementById('camera-feed');
        const guideOverlay = document.getElementById('guide-overlay');
        const tipBox = document.getElementById('tip-box');
        const canvas = document.getElementById('photo-canvas');
        
        // 1. å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            try {
                // constraint: environment è¡¨ç¤ºåç½®æ‘„åƒå¤´
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' },
                    audio: false 
                });
                video.srcObject = stream;
                tipBox.innerText = "ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©åœºæ™¯";
            } catch (err) {
                console.error("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:", err);
                tipBox.innerText = "æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™æˆ–ä½¿ç”¨HTTPSè®¿é—®";
                // æç¤ºï¼šiOS Safari å’Œ Chrome åªå…è®¸åœ¨ localhost æˆ– HTTPS ç¯å¢ƒä¸‹è°ƒç”¨æ‘„åƒå¤´
            }
        }

        // 2. åœºæ™¯åˆ‡æ¢é€»è¾‘
        const scenarios = {
            'none': { html: '', tip: 'è‡ªç”±å‘æŒ¥' },
            'cafe': { 
                html: '<div class="guide-cafe"><div class="frame"></div></div>', 
                tip: 'è®©å¥¹çš„æ‰‹è‡ªç„¶æ­åœ¨æ¡Œä¸Šï¼Œå°†ä¸ŠåŠèº«æ”¾å…¥æ¡†å†…' 
            },
            'street': { 
                html: `
                    <div class="guide-street">
                        <div class="grid-line-h" style="top: 33%"></div>
                        <div class="grid-line-h" style="top: 66%"></div>
                        <div class="grid-line-v" style="left: 33%"></div>
                        <div class="grid-line-v" style="left: 66%"></div>
                        <div class="focus-point"></div>
                    </div>`,
                tip: 'ä¸‰åˆ†æ³•æ„å›¾ï¼šå°†çœ¼ç›å¯¹å‡†çº¢åœˆï¼ŒèƒŒæ™¯è™šåŒ–'
            },
            'park': { 
                html: '<div class="guide-park"><div class="silhouette">è„šå°–å¯¹é½åº•éƒ¨</div></div>', 
                tip: 'ä¾§èº«ç«™ç«‹ï¼Œä¸€æ¡è…¿å‘é•œå¤´å»¶ä¼¸'
            }
        };

        function setScenario(type) {
            // æ›´æ–° UI æ ·å¼
            document.querySelectorAll('.scenario-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // æ›´æ–°å¼•å¯¼å±‚å†…å®¹
            if (scenarios[type]) {
                guideOverlay.innerHTML = scenarios[type].html;
                tipBox.innerText = scenarios[type].tip;
            }
        }

        // 3. æ‹ç…§åŠŸèƒ½
        function takePhoto() {
            // è®¾ç½® Canvas å¤§å°ä¸è§†é¢‘ä¸€è‡´
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // å°†è§†é¢‘å½“å‰å¸§ç”»åˆ° Canvas ä¸Š
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // å¯¼å‡ºä¸ºå›¾ç‰‡å¹¶ä¸‹è½½
            // æ³¨æ„ï¼šåœ¨æœ‰äº›æ‰‹æœºæµè§ˆå™¨ï¼ˆå¦‚å¾®ä¿¡å†…ç½®æµè§ˆå™¨ï¼‰ï¼Œè‡ªåŠ¨ä¸‹è½½å¯èƒ½ä¼šè¢«æ‹¦æˆª
            // æ›´å¥½çš„åšæ³•æ˜¯æ˜¾ç¤ºç”Ÿæˆçš„å›¾ç‰‡ï¼Œè®©ç”¨æˆ·é•¿æŒ‰ä¿å­˜ã€‚
            // è¿™é‡Œä¸ºäº†ç®€å•æ¼”ç¤ºï¼Œç›´æ¥å°è¯•ç”Ÿæˆé“¾æ¥ã€‚
            
            try {
                const dataUrl = canvas.toDataURL('image/jpeg');
                
                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.download = 'pose-mate-photo-' + Date.now() + '.jpg';
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // ç®€å•çš„è§†è§‰åé¦ˆ
                const originalTip = tipBox.innerText;
                tipBox.innerText = "ğŸ“¸ ç…§ç‰‡å·²ç”Ÿæˆï¼";
                setTimeout(() => tipBox.innerText = originalTip, 2000);
            } catch (e) {
                alert("æ‹ç…§ä¿å­˜å¤±è´¥ï¼Œè¯·æˆªå›¾ä¿å­˜ã€‚");
            }
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', startCamera);
    </script>
</body>
</html>